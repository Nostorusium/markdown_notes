# 驱动程序与中断

在组成上来讲，设备属于IO系统的一部分。在硬件层面，设备通过总线等与CPU相连，我们在此基础上提出DMA方式。
驱动程序是用来连接设备硬件与操作系统的软件，它提供了设备的具体接口。系统调用是通过驱动程序完成具体的设备操作的。
此外，在用户侧使用设备的逻辑号来访问设备。  

操作系统通过系统调用,如open,read,write向用户提供一个统一的接口，而底层去实现设备的细节。

## 设备驱动程序

驱动程序是操作系统的一部分，我们在上层使用如read,write的统一系统调用接口，下层则由驱动程序完成细节处理。
OS通过统一接口向**驱动程序**发送设备请求，随后**驱动程序**通过设备控制器发送命令，读取数据或更改设备状态。

驱动程序也有类别。
- 字符设备：如键盘鼠标，串口。OS提供read,write,ioctl
- 块设备:如硬盘等,OS。OS提供了read_block,write_block,flush等
- 网络设备驱动
- 虚拟设备驱动

通常而言驱动程序作为OS的一个模块，如Linux的内核模块modprobe，并实现如open,read,write此类接口的具体实现。

## 中断

当设备完成某项操作后，设备向CPU发出中断信号，随后CPU转入中断处理。
中断处理程序会调用**设备驱动**来完成与该设备相关的具体操作。如读入键盘数据。

>当你敲击键盘，键盘发出IO中断，CPU处理IO中断，驱动程序将输入的数据读入内核缓冲区。随后，他们被载入用户态执行用户态逻辑。

## 为什么设备需要装驱动

如果你买了一个键盘，你会发现这个东西插上就能用，你无需任何额外的驱动程序。这是因为键盘几乎所有的硬件都遵循标准的输入协议。
不同厂商的键盘几乎不需要单独的驱动程序，通过标准的接口，操作系统就可以自动识别和处理设备了。  

而打印机不行。打印机的硬件差异很大，不同型号，品牌可能有不同的接口与通信协议。这通常意味着你需要安装额外的驱动程序来指示OS。

当你买了一个打印机并安装了他的驱动程序，驱动程序会向OS注册响应的设备接口。尽管这种驱动程序并不像预先安装好的键盘驱动一样存在于OS内核，而是后天安装载入的，但该驱动程序仍是在OS与设备交互的场景下才发挥作用。